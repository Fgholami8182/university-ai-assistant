<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>๐ค ุฏุณุชุงุฑ ุฏุงูุดฺฏุงู</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v34.0.0/dist/font-face.css" rel="stylesheet">
<style>
:root{
  --logo-red: #c62828;
  --logo-green: #1b8f4a;
  --bg-from: #f8fff8;
  --bg-to: #fff7f7;
  --bubble-radius: 18px;
}
body{ font-family: "Vazirmatn", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
.bubble { white-space: pre-wrap; line-height: 1.45; }
.btn-primary { background: var(--logo-red); }
.btn-primary:hover { filter: brightness(0.94); }
.bot-bubble-logo { width: 28px; height: 28px; object-fit: contain; border-radius: 6px; }
.top-border { border-top-width: 6px; border-top-color: var(--logo-red); }
.cooldown { font-size: 0.9rem; color: #6b7280; }
.modal-backdrop { position: fixed; inset: 0; background: rgba(2,6,23,0.5); display: flex; align-items: center; justify-content: center; z-index: 60; }
.modal-card { width: 95%; max-width: 760px; background: white; border-radius: 14px; padding: 20px; box-shadow: 0 8px 30px rgba(2,6,23,0.15); direction: rtl; text-align: right; }
.about-top { position: absolute; top: 12px; left: 16px; background: white; padding: 8px 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(2,6,23,0.06); cursor: pointer; font-weight: 600; color: var(--logo-green); }
</style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-b from-[var(--bg-from)] to-[var(--bg-to)] p-4">

<div class="about-top" id="aboutTopBtn">ุฏุฑุจุงุฑู</div>
<div class="w-full max-w-3xl">

<!-- VERIFY BOX -->
<div id="verify-box" class="bg-white shadow-lg rounded-2xl p-6 top-border">
  <div class="flex items-center justify-center mb-4">
    <img src="{{ url_for('static', filename='shahed_logo.png') }}" alt="ููฺฏู ุฏุงูุดฺฏุงู" class="h-20">
  </div>
  <h2 class="text-center text-xl font-semibold text-[var(--logo-green)] mb-2">ูุฑูุฏ ุจู ุฏุณุชุงุฑ ุฏุงูุดฺฏุงู</h2>
  <p class="text-center text-gray-600 mb-4">ุจุฑุง ุฌููฺฏุฑ ุงุฒ ูุฑูุฏ ุฑุจุงุชโูุงุ ูุทูุงู ุจู ุณุคุงู ุฒุฑ ูพุงุณุฎ ุฏูุฏ:</p>
  <div class="flex items-center justify-center gap-3 text-lg font-bold text-[var(--logo-red)] mb-3">
    <span id="num1" class="w-8 text-center"></span>
    <span id="op" class="w-6 text-center">+</span>
    <span id="num2" class="w-8 text-center"></span>
    <span>=</span>
    <input id="mathAnswer" type="number" class="w-20 border border-gray-300 rounded-lg p-2 text-center" />
  </div>
  <div class="flex items-center justify-center gap-3">
    <button id="verifyBtn" class="px-5 py-2 rounded-2xl text-white btn-primary">ุงุฏุงูู</button>
    <button id="regenBtn" class="px-4 py-2 rounded-2xl border border-gray-200 text-gray-700">ุชุบุฑ</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="main-app" class="hidden mt-6 flex flex-col gap-4">
  <header class="flex items-center justify-center bg-white rounded-2xl p-4 shadow-md border border-green-100 relative">
    <img src="{{ url_for('static', filename='shahed_logo.png') }}" alt="ููฺฏู ุฏุงูุดฺฏุงู" class="h-20 mr-3">
    <div class="text-right">
      <h1 class="text-lg font-bold text-[var(--logo-red)]">ุฏุณุชุงุฑ ุขูโูุงููโุง ุฏุงูุดฺฏุงู</h1>
      <p class="text-sm text-gray-600">ูพุงุณุฎโูุง ุจุฑ ุงุณุงุณ ุขูโูุงููโูุง ุจุงุฑฺฏุฐุงุฑโุดุฏู ุงุฑุงุฆู ูโุดูุฏ.</p>
    </div>
    <button id="openFeedbackBtn" class="absolute left-4 top-4 px-3 py-1 rounded-lg border text-sm">ุจุงุฒุฎูุฑุฏ</button>
  </header>

  <div class="bg-white rounded-2xl p-4 shadow-sm border-l-4 border-[var(--logo-green)]">
    <p class="text-gray-700">ุงู ูุญุท ุจุฑุง ูพุฑุณุด ู ูพุงุณุฎ ุฏุฑุจุงุฑูู ุขูโูุงููโูุง ุฏุงูุดฺฏุงู ุทุฑุงุญ ุดุฏู ุงุณุช. ูุฑ IP ููุท ูุฑ 5 ุซุงูู ฺฉ ุณูุงู ูโุชูุงูุฏ ุงุฑุณุงู ฺฉูุฏ (ฺฉูุชุฑูโุดุฏู ุฏุฑ ุณุฑูุฑ).</p>
  </div>

  <div id="chat-box" class="bg-white rounded-2xl p-4 shadow-lg flex-1 overflow-y-auto" style="min-height: 360px; max-height: calc(100vh - 380px); direction: rtl;">
    <!-- ูพุงูโูุง ุงูุฌุง ุงุถุงูู ูุดู -->
  </div>

  <div class="flex items-center gap-3">
    <input id="question" type="text" dir="rtl" placeholder="ุณูุงูุช ุฑู ุงูุฌุง ุจููุณ..." class="flex-1 px-4 py-3 rounded-2xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[var(--logo-red)]"/>
    <div class="flex flex-col items-end gap-2">
      <button id="sendBtn" class="px-5 py-2 rounded-2xl text-white btn-primary">ุงุฑุณุงู</button>
      <div id="cooldown" class="cooldown"></div>
    </div>
  </div>
</div>
</div>

<!-- ABOUT MODAL -->
<div id="aboutModal" class="hidden modal-backdrop">
  <div class="modal-card">
    <h3 class="text-xl font-bold text-[var(--logo-green)] mb-3">ุฏุฑุจุงุฑูู ูพุฑูฺู</h3>
    <div class="prose text-gray-800 mb-4" style="line-height:1.7">
      <p>ุงู ุณุงูุงูู ูุชุฌูู ูพุฑูฺูู ฺฉุงุฑุดูุงุณ ุฏุฑ ุฏุงูุดฺฏุงู ุดุงูุฏ ูโุจุงุดุฏ.</p>
      <p><strong>ุฏุงูุดุฌู:</strong> ูุงุทูู ุบูุงู<br>
      <strong>ุงุณุชุงุฏ ุฑุงูููุง:</strong> ุฌูุงุจ  ุฏฺฉุชุฑ ูุญุฏ ุญููุชโุฏูุณุช</p>

      <p>ุณุงูุงูู ุจุง ุจูุฑูโฺฏุฑ ุงุฒ ููุงูุฑโูุง <strong>ููุด ูุตููุน</strong> ู <strong>ูพุฑุฏุงุฒุด ุฒุจุงู ุทุจุน (NLP)</strong> ุทุฑุงุญ ุดุฏู ุงุณุช. ุฏุฑ ุจุฎุด ุจุงุฒุงุจ ููุงููุ ุงุฒ <strong>ูุฏู BERT</strong> (ุจูโุทูุฑ ุฏููโุชุฑ Sentence-BERT) ุจุฑุง ูุญุงุณุจูู ุดุจุงูุช ูุนูุง ุจู ูพุฑุณุด ุฏุงูุดุฌู ู ูุชู ุขูโูุงูู ุงุณุชูุงุฏู ุดุฏู ุงุณุช. ุณูพุณ ุจุฑุง ุชููุฏ ูพุงุณุฎ ููุงุ ุงุฒ <strong>ูุฏู LLaMA</strong> (ูุณุฎูู ณ.ณ ุจุง ทฐ ููุงุฑุฏ ูพุงุฑุงูุชุฑ) ุงุณุชูุงุฏู ูโุดูุฏ ฺฉู ฺฉ ุงุฒ ูุฏุฑุชููุฏุชุฑู ูุฏูโูุง ุฒุจุงู ุงูุฑูุฒ ุงุณุช.</p>

      <p>ุงู ุชุฑฺฉุจ ุจุงุนุซ ูโุดูุฏ ุณุงูุงูู ุงุจุชุฏุง ุจูุฏูุง ูุฑุชุจุท ุงุฒ ุขูโูุงููโูุง ุฑุง ูพุฏุง ฺฉุฑุฏู ู ุณูพุณ ูพุงุณุฎ ุฑูุงู ู ูุงุจูโููู ุจุฑ ุงุณุงุณ ุขูโูุง ุชููุฏ ููุงุฏ.</p>

      <p>ุจุฑุง ูุดุงูุฏูู ฺฉุงูู ุขูโูุงููโูุง ูโุชูุงูุฏ ุงุฒ ูพููุฏ ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:</p>
      <p><a id="rulesLink" href="https://drive.google.com/drive/folders/1B3LuqlSGyZfIr7f-t3niJE8PMlT32-JZ?usp=drive_link" target="_blank" class="underline text-[var(--logo-red)]">[ููฺฉ ุขูโูุงููโูุง โ ุงูุฌุง ฺฉูฺฉ ฺฉูุฏ]</a>
      </p>
      <p>ุจุฑุง ุฏุฑุงูุช ูพุงุณุฎโูุง ุฏููโุชุฑุ ูุทูุงู ุณูุงูโูุง ุฑุง ฺฉูุชุงูุ ุฑูุดู ู ุจุฏูู ุงุฑุงุฏ ุงููุง ูุทุฑุญ ฺฉูุฏ. ุงุฒ ุงูฺฉู ููุช ฺฏุฐุงุดุชุฏ ู ุงุฒ ุงู ูพุฑูฺู ุจุงุฒุฏุฏ ูโฺฉูุฏ ุจโููุงุช ุณูพุงุณฺฏุฒุงุฑู โ ุงุฑุณุงู ุจุงุฒุฎูุฑุฏ ุดูุง ุฏุฑ ุจุฎุด ยซุจุงุฒุฎูุฑุฏยป ููโููุท ุจุงุนุซ ุฏูฺฏุฑู ุงุณุชุ ฺฉู ููุด ุงุณุงุณ ุฏุฑ ุจูุจูุฏู ูุณุฎูโูุง ุขุช ุฎูุงูุฏ ุฏุงุดุช.</p>
    </div>
    <div class="flex items-center justify-end gap-3">
      <button id="aboutClose" class="px-4 py-2 rounded-2xl border">ุจุณุชู</button>
      <button id="aboutConfirm" class="px-4 py-2 rounded-2xl text-white btn-primary">ุฎูุงูุฏู ู ุงุฏุงูู ูโุฏูู</button>
    </div>
  </div>
</div>

<!-- FEEDBACK MODAL -->
<div id="feedbackModal" class="hidden modal-backdrop">
  <div class="modal-card">
    <h3 class="text-lg font-bold text-[var(--logo-red)] mb-3">ุงุฑุณุงู ุจุงุฒุฎูุฑุฏ</h3>
    <p class="text-sm text-gray-600 mb-3">ุฏุฑ ุงู ุจุฎุด ฺูุงูฺู ูุทูุจ ุจุฑุง ุขููุฒุด ูุฏ ูุธุฑ ุฏุงุฑุฏุ ููฺูู ูพุดููุงุฏุงุช ุฎูุฏ ุจุฑุง ุจูุจูุฏ ฺฉุงุฑุจุฑ ุณุงูุงูู ุฑุง ูุชูุงูุฏ ุงุฑุณุงู ููุงุฏ.</p>
    <div class="flex flex-col gap-3">
      <input id="fbName" type="text" placeholder="ูุงู (ุงุฎุชุงุฑ)" class="px-3 py-2 border rounded-lg"/>
      <textarea id="fbText" rows="6" placeholder="ูุชู ุจุงุฒุฎูุฑุฏ..." class="px-3 py-2 border rounded-lg"></textarea>
      <div class="flex items-center justify-end gap-2">
        <button id="feedbackCancel" class="px-4 py-2 rounded-2xl border">ูุบู</button>
        <button id="feedbackSend" class="px-4 py-2 rounded-2xl text-white btn-primary">ุงุฑุณุงู ุจุงุฒุฎูุฑุฏ</button>
      </div>
    </div>
    <div id="feedbackStatus" class="mt-3 text-sm text-gray-600"></div>
  </div>
</div>

<script>
// ---------- ุชููุฏ ุณูุงู ุฑุงุถ ุณุงุฏู ----------
let num1 = 0, num2 = 0, op = '+', correctAnswer = 0;
const num1El = document.getElementById('num1');
const num2El = document.getElementById('num2');
const opEl = document.getElementById('op');
const mathAnswer = document.getElementById('mathAnswer');
const verifyBtn = document.getElementById('verifyBtn');
const regenBtn = document.getElementById('regenBtn');
const verifyBox = document.getElementById('verify-box');
const mainApp = document.getElementById('main-app');
const chatBox = document.getElementById('chat-box');
const input = document.getElementById('question');
const sendBtn = document.getElementById('sendBtn');
const cooldownEl = document.getElementById('cooldown');
const aboutModal = document.getElementById('aboutModal');
const aboutTopBtn = document.getElementById('aboutTopBtn');
const aboutClose = document.getElementById('aboutClose');
const aboutConfirm = document.getElementById('aboutConfirm');
const rulesLink = document.getElementById('rulesLink');
const feedbackModal = document.getElementById('feedbackModal');
const openFeedbackBtn = document.getElementById('openFeedbackBtn');
const feedbackCancel = document.getElementById('feedbackCancel');
const feedbackSend = document.getElementById('feedbackSend');
const fbName = document.getElementById('fbName');
const fbText = document.getElementById('fbText');
const feedbackStatus = document.getElementById('feedbackStatus');

function generateMath(){
  num1 = Math.floor(Math.random() * 9) + 1;
  num2 = Math.floor(Math.random() * 9) + 1;
  op = Math.random() > 0.5 ? '+' : '-';
  correctAnswer = (op === '+') ? (num1 + num2) : (num1 - num2);
  num1El.textContent = num1;
  num2El.textContent = num2;
  opEl.textContent = op;
  mathAnswer.value = '';
  mathAnswer.focus();
}
generateMath();
regenBtn.addEventListener('click', generateMath);

// ---------- ุชุงุฏ ูพุงุณุฎ ----------
verifyBtn.addEventListener('click', () => {
  const user = parseInt(mathAnswer.value);
  if (isNaN(user)) { alert('ูุทูุงู ูพุงุณุฎ ุฑุง ูุงุฑุฏ ฺฉูุฏ.'); mathAnswer.focus(); return; }
  if (user !== correctAnswer) { alert('ูพุงุณุฎ ุงุดุชุจุงู ุงุณุช. ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.'); generateMath(); return; }
  verifyBox.classList.add('hidden');
  showAboutModal();
});

function showAboutModal(){ aboutModal.classList.remove('hidden'); }
function hideAboutModal(){ aboutModal.classList.add('hidden'); }
aboutTopBtn.addEventListener('click', showAboutModal);
aboutClose.addEventListener('click', () => { hideAboutModal(); });
aboutConfirm.addEventListener('click', () => {
  hideAboutModal();
  mainApp.classList.remove('hidden');
  input.focus();
  appendBotMessage('ุณูุงู! ูู ุฏุณุชุงุฑ ุขูโูุงููโุง ูุณุชู. ุณูุงูุช ุฑุง ุจููุณ ุชุง ุจุฑ ุงุณุงุณ ููุงูู ูพุงุณุฎ ุจุฏูู.');
});

// ---------- ูพุงูโูุง ----------
function createBubbleElement(text, isUser=false){
  const row = document.createElement('div');
  row.className = `w-full flex ${isUser ? 'justify-end' : 'justify-start'} gap-3 mb-3`;
  const bubble = document.createElement('div');
  bubble.className = 'bubble px-5 py-3 shadow-sm';
  bubble.style.maxWidth = '82%';
  bubble.style.borderRadius = 'var(--bubble-radius)';
  bubble.style.whiteSpace = 'pre-wrap';
  if(isUser){
    bubble.classList.add('text-white');
    bubble.style.background = 'var(--logo-red)';
    bubble.style.borderBottomRightRadius = '6px';
    bubble.style.borderBottomLeftRadius = '18px';
    bubble.style.textAlign = 'right';
    bubble.textContent = text;
    row.appendChild(bubble);
  } else {
    const container = document.createElement('div');
    container.className = 'flex items-start gap-2';
    const logo = document.createElement('img');
    logo.src = "{{ url_for('static', filename='shahed_logo.png') }}";
    logo.alt = "ููฺฏู";
    logo.className = 'bot-bubble-logo';
    container.appendChild(logo);
    bubble.style.background = 'rgba(30,143,74,0.08)';
    bubble.style.color = '#0f172a';
    bubble.style.border = '1px solid rgba(30,143,74,0.12)';
    bubble.style.textAlign = 'right';
    bubble.textContent = text;
    container.appendChild(bubble);
    row.appendChild(container);
  }
  return row;
}
function appendBotMessage(text){ const el = createBubbleElement(text, false); chatBox.appendChild(el); chatBox.scrollTop = chatBox.scrollHeight; }
function appendUserMessage(text){ const el = createBubbleElement(text, true); chatBox.appendChild(el); chatBox.scrollTop = chatBox.scrollHeight; }

// ---------- ุงุฑุณุงู ุณูุงู ----------
let cooldownTimer = null;
function startCooldown(seconds){
  clearInterval(cooldownTimer);
  let remaining = seconds;
  sendBtn.disabled = true;
  input.disabled = true;
  updateCooldownText(remaining);
  cooldownTimer = setInterval(()=>{
    remaining--;
    updateCooldownText(remaining);
    if(remaining<=0){ clearInterval(cooldownTimer); sendBtn.disabled=false; input.disabled=false; cooldownEl.textContent=''; }
  },1000);
}
function updateCooldownText(sec){ const m=Math.floor(sec/60); const s=sec%60; cooldownEl.textContent=`ุดูุง ูโุชูุงูุฏ ูพุณ ุงุฒ ${m}:${s.toString().padStart(2,'0')} ุฏูุจุงุฑู ุณูุงู ุจูพุฑุณุฏ.`; }

async function sendMessage(){
  const question=input.value.trim(); if(!question)return;
  appendUserMessage(question); input.value='';
  try{
    const res=await fetch('/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question})});
    if(res.status===429){ let retrySeconds=120; const ra=res.headers.get('Retry-After'); if(ra){ const parsed=parseInt(ra); if(!isNaN(parsed)) retrySeconds=parsed; } const data=await res.json().catch(()=>({})); appendBotMessage(data.answer||data.detail||'ุดูุง ุฏุฑ ูุญุฏูุฏุช ุฒูุงู ูุณุชุฏ. ูุทูุงู ุจุนุฏุงู ุชูุงุด ฺฉูุฏ.'); startCooldown(retrySeconds); return; }
    if(!res.ok){ appendBotMessage('ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ. ุจุนุฏุงู ุงูุชุญุงู ฺฉูุฏ.'); return; }
    const data=await res.json(); appendBotMessage(data.answer||'ูพุงุณุฎ ุงุฒ ุณุฑูุฑ ุฏุฑุงูุช ูุดุฏ.'); startCooldown(5);
  } catch(err){ console.error(err); appendBotMessage('ุฎุทุง ุฏุฑ ุงุฑุณุงู ุฏุฑุฎูุงุณุช. ุงูุชุฑูุช ุง ุณุฑูุฑ ุฑุง ุจุฑุฑุณ ฺฉูุฏ.'); }
}
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keydown',(e)=>{if(e.key==='Enter')sendMessage();});

// ---------- Feedback ----------
openFeedbackBtn.addEventListener('click',()=>{ feedbackStatus.textContent=''; fbName.value=''; fbText.value=''; feedbackModal.classList.remove('hidden'); });
feedbackCancel.addEventListener('click',()=>{ feedbackModal.classList.add('hidden'); });
feedbackSend.addEventListener('click',async()=>{
  const name=fbName.value.trim(); const feedback=fbText.value.trim();
  if(!feedback){ feedbackStatus.textContent='ูุทูุงู ูุชู ุจุงุฒุฎูุฑุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ.'; feedbackStatus.style.color='crimson'; return; }
  feedbackStatus.textContent='ุฏุฑ ุญุงู ุงุฑุณุงู...'; feedbackStatus.style.color='#6b7280'; feedbackSend.disabled=true;
  try{
    const res=await fetch('/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,feedback})});
    const data=await res.json();
    if(res.ok && data.success){ feedbackStatus.textContent='ุจุงุฒุฎูุฑุฏ ุดูุง ุซุจุช ุดุฏุ ุณูพุงุณฺฏุฒุงุฑู.'; feedbackStatus.style.color='green'; feedbackModal.classList.add('hidden'); appendBotMessage('ุจุงุฒุฎูุฑุฏ ุดูุง ุจุง ููููุช ุซุจุช ุดุฏ. ููููู ุงุฒ ูุดุงุฑฺฉุช ุดูุง!'); }
    else{ feedbackStatus.textContent=data.message||'ุฎุทุง ุฏุฑ ุงุฑุณุงู ุจุงุฒุฎูุฑุฏ.'; feedbackStatus.style.color='crimson'; }
  }catch(err){ console.error(err); feedbackStatus.textContent='ุฎุทุง ุฏุฑ ุงุฑุณุงู ุจุงุฒุฎูุฑุฏ. ูุทูุงู ุจุนุฏุงู ุชูุงุด ฺฉูุฏ.'; feedbackStatus.style.color='crimson'; }
  finally{ feedbackSend.disabled=false; }
});
</script>

</body>
</html>
